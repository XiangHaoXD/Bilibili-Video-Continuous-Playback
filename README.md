# 感谢AI和这个时代

整个项目除本段外全部由AI生成，感谢GPT-5.2-Instant和Claude-Sonnet-4.5。
这个项目最初的想法是在刷B站视频和打游戏时产生的。我习惯在电脑上打开许多B站视频标签页，然后一边观看一边打游戏。但人只有两只手，有时候游戏进行到关键时刻视频播完了就很难受，至此想有一个能够自动切换浏览器标签页的浏览器插件的想法。
**本项目只在B站网页视频中进行了测试，插件使用时需要在B站视频的播放设置中开启自动开播。**


# URL Logger - Chrome Extension

一个功能强大的 Chrome 浏览器扩展，用于自动记录访问的 URL，检测网页媒体播放状态，并支持视频播放完毕后自动切换标签页。

## ✨ 主要功能

### 📝 URL 记录
- 自动记录访问的网页 URL 和时间戳
- 按日期分类存储访问记录
- 支持一键下载当日记录为 txt 文件

### 🎬 媒体检测
- 实时检测网页中的视频和音频播放状态
- 区分"正在播放"和"已播放完成"两种状态
- 支持主文档、Shadow DOM 和同源 iframe 中的媒体元素
- 详细记录媒体数量（视频/音频）

### 🔄 自动切换标签页
- 视频播放完毕后自动切换到下一个标签页
- 可自由开启/关闭此功能
- 智能循环切换（到达最后一个标签页时回到第一个）
- 防重复触发机制

## 📦 安装方法

### 开发者模式安装

1. 下载或克隆此项目到本地

2. 打开 Chrome 浏览器，进入扩展程序管理页面
   - 访问 `chrome://extensions/`
   - 或点击右上角菜单 → 更多工具 → 扩展程序

3. 启用"开发者模式"（右上角开关）

4. 点击"加载已解压的扩展程序"

5. 选择项目文件夹

6. 扩展安装完成！

## 🚀 使用指南

### 基本操作

1. **开始记录**
   - 点击扩展图标打开弹窗
   - 点击"开始记录"按钮
   - 状态显示为"正在记录中..."

2. **停止记录**
   - 点击"停止记录"按钮
   - 状态显示为"记录已停止"

3. **下载记录**
   - 点击"下载今日记录"按钮
   - 文件自动保存为 `urls-YYYY-MM-DD.txt`

4. **自动切换标签页**
   - 打开扩展弹窗
   - 启用"视频结束后自动切换"开关
   - 当视频播放完毕后，将自动切换到下一个标签页

### 日志格式示例

```
14:30:25 https://www.example.com/video1 [PLAYING: 1V 0A]
14:35:10 https://www.example.com/video2 [PLAYED: 1V 0A]
14:40:03 https://music.example.com [PLAYING: 0V 1A]
```

格式说明：
- 时间戳（时:分:秒）
- URL 地址
- 媒体状态标记：
  - `[PLAYING: XV YA]` - 正在播放 X 个视频，Y 个音频
  - `[PLAYED: XV YA]` - 已播放完成 X 个视频，Y 个音频

## 🏗️ 项目结构

```
url-logger/
├── manifest.json          # 扩展配置文件
├── background.js          # 后台服务脚本
├── content.js            # 内容脚本（注入网页）
├── popup.html            # 弹窗界面
├── popup.js              # 弹窗交互逻辑
├── offscreen.html        # 离屏文档
├── offscreen.js          # 文件下载处理
└── README.md             # 项目文档
```

## 🔧 技术特性

### Manifest V3
- 采用最新的 Chrome Extension Manifest V3 规范
- 使用 Service Worker 替代传统 Background Page
- 更好的性能和安全性

### 媒体检测技术
- **多层级扫描**：支持主文档、Shadow DOM、iframe
- **实时监听**：使用 MutationObserver 监听动态内容
- **性能优化**：防抖机制、页面隐藏时停止检测
- **健壮性**：完善的错误处理和上下文失效检测

### 数据存储
- 使用 `chrome.storage.local` 本地存储
- 按日期分类管理日志
- 支持大量数据存储

### 自动切换机制
- 智能状态追踪，避免重复触发
- 延迟切换，提供更好的用户体验
- 循环切换，支持连续观看

## ⚙️ 权限说明

扩展需要以下权限：

| 权限 | 用途 |
|------|------|
| `tabs` | 访问标签页信息，实现自动切换 |
| `downloads` | 下载日志文件 |
| `storage` | 存储访问记录和设置 |
| `offscreen` | 创建离屏文档处理文件下载 |
| `activeTab` | 访问当前活动标签页 |
| `<all_urls>` | 在所有网页上检测媒体播放 |

## 📊 应用场景

### 适用于：
- 📚 **在线学习**：记录学习路径，自动切换课程视频
- 🎵 **音乐播放**：追踪播放历史
- 📺 **视频观看**：连续播放多个视频标签页
- 🔍 **研究分析**：追踪浏览行为
- 📖 **知识管理**：整理访问过的资源

### 特别适合：
- 需要连续观看多个教学视频的学生
- 批量处理视频内容的研究人员
- 需要记录浏览历史的专业人士

## 🎨 界面预览

### 弹窗界面
- 现代化的渐变背景设计
- 清晰的状态指示（记录中/已停止）
- 直观的切换开关
- 友好的消息提示

### 状态指示
- ✅ 绿色：记录中 / 功能已启用
- ❌ 红色：已停止 / 功能已关闭

## 🔄 更新日志

### v1.0.9 (2026-01-08)
- ✨ 新增视频播放完毕后自动切换标签页功能
- 🎛️ 添加自动切换开关控制
- 🐛 修复上下文失效问题
- ⚡ 优化媒体检测性能

### v1.0.8
- 🎬 完善媒体检测机制
- 📝 改进日志格式
- 🔧 修复已知 bug

### v1.0.0
- 🎉 首次发布
- 📝 基础 URL 记录功能
- 🎵 媒体播放检测

## ⚠️ 注意事项

1. **隐私保护**
   - 所有数据仅存储在本地浏览器中
   - 不会上传到任何服务器
   - 可随时清除存储数据

2. **性能影响**
   - 扩展经过优化，对浏览器性能影响极小
   - 使用防抖和智能检测机制
   - 页面隐藏时自动停止检测

3. **兼容性**
   - 仅支持基于 Chromium 的浏览器（Chrome、Edge、Brave 等）
   - 需要浏览器版本 88 或更高
   - 不支持跨域 iframe 中的媒体检测

4. **自动切换功能**
   - 仅在视频播放完毕时触发（不包括音频）
   - 默认延迟 1 秒后切换
   - 可通过开关自由控制

## 🛠️ 开发调试

### 查看日志
```javascript
// 打开扩展的 Service Worker 控制台
chrome://extensions/ → URL Logger → Service Worker（查看）

// 查看内容脚本日志
在任意网页按 F12 → Console
```

### 清除存储数据
```javascript
// 在控制台执行
chrome.storage.local.clear();
```

### 手动触发媒体检测
```javascript
// 在网页控制台执行
chrome.runtime.sendMessage({ type: 'CHECK_MEDIA' });
```

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

1. Fork 本项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 📄 开源协议

本项目采用 MIT 协议开源 - 查看 [LICENSE](LICENSE) 文件了解详情

## 💡 常见问题

### Q: 为什么有些视频没有被检测到？
A: 可能原因：
- 视频在跨域 iframe 中（出于安全限制无法检测）
- 视频使用了特殊播放器（如 Flash）
- 页面使用了复杂的 Shadow DOM 结构

### Q: 自动切换功能不工作？
A: 请检查：
- 是否已启用"视频结束后自动切换"开关
- 当前标签页中的视频是否确实播放完毕
- 浏览器是否有多个标签页

### Q: 如何导出历史记录？
A: 每次只能下载当天的记录。如需导出历史记录，可以：
1. 打开开发者工具
2. 执行 `chrome.storage.local.get('logsByDate', console.log)`
3. 手动复制数据

### Q: 扩展占用多少存储空间？
A: 取决于使用频率。平均每天约 10-50 KB。Chrome 扩展的存储限制为 10 MB，足够使用数月。

---

**如果这个扩展对您有帮助，请给个 ⭐️ Star！**
